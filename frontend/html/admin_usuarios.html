<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin: Gestión de Usuarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Gestión de Usuarios y Roles</h1>
        <a href="index.html" class="btn btn-secondary mb-3">Volver al Dashboard</a>
        
        <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addAdminModal">
            Añadir Nuevo Administrador
        </button>
        
        <div id="loading" class="text-info">Cargando usuarios...</div>
        <div id="usersTableContainer">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID Usuario</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Rol Actual</th>
                        <th>Teléfono</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    </tbody>
            </table>
        </div>
        <div id="errorMsg" class="alert alert-danger d-none"></div>
    </div>

    <div class="modal fade" id="addAdminModal" tabindex="-1" aria-labelledby="addAdminModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAdminModalLabel">Añadir Nuevo Administrador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addAdminForm">
                        <div class="mb-3">
                            <label for="aNombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="aNombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="aEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="aEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="aPassword" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="aPassword" required>
                        </div>
                         <div class="mb-3">
                            <label for="aTelefono" class="form-label">Teléfono (Opcional)</label>
                            <input type="text" class="form-control" id="aTelefono">
                        </div>
                        <button type="submit" class="btn btn-success">Registrar Admin</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000';
        const tbody = document.getElementById('usersTableBody');
        const addForm = document.getElementById('addAdminForm');
        const errorMsg = document.getElementById('errorMsg');
        const loading = document.getElementById('loading');


        async function cargarTodosLosUsuarios() {
            loading.style.display = 'block';
            errorMsg.classList.add('d-none');
            
            try {
                // Llama a la ruta que lista TODOS los usuarios
                const response = await fetch(`${API_URL}/api/admin/usuarios/all`, { credentials: 'include' });
                
                if (response.status === 403) {
                    alert('Acceso denegado. No eres administrador.');
                    window.location.href = 'index.html';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const usuarios = await response.json();
                tbody.innerHTML = ''; 

                if (usuarios.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No hay usuarios registrados.</td></tr>';
                    return;
                }

                usuarios.forEach(u => {
                    const esAdmin = u.rol === 'admin';
                    
                    // Condición para PROMOCIÓN o DEGRADACIÓN
                    const actionButton = esAdmin 
                        ? `<button class="btn btn-warning btn-sm demote-user" data-id="${u.id_usuario}">Degradar</button>`
                        : `<button class="btn btn-success btn-sm promote-user" data-id="${u.id_usuario}">Promover</button>`;
                        
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${u.id_usuario}</td>
                        <td>${u.nombre}</td>
                        <td>${u.email}</td>
                        <td><span class="badge bg-${esAdmin ? 'danger' : 'secondary'}">${u.rol.toUpperCase()}</span></td>
                        <td>${u.telefono || 'N/A'}</td>
                        <td>${actionButton}</td>
                    `;
                });

            } catch (error) {
                console.error('Error al cargar usuarios:', error);
                errorMsg.textContent = `Error: No se pudieron cargar los usuarios. Verifique que la ruta de API /api/admin/usuarios/all esté activa.`;
                errorMsg.classList.remove('d-none');
            } finally {
                loading.style.display = 'none';
            }
        }

        // Listener para REGISTRAR ADMIN (POST /api/register/admin)
        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nuevoAdmin = {
                nombre: document.getElementById('aNombre').value,
                email: document.getElementById('aEmail').value,
                password: document.getElementById('aPassword').value,
                telefono: document.getElementById('aTelefono').value,
            };

            try {
                const response = await fetch(`${API_URL}/api/register/admin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nuevoAdmin),
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Administrador registrado exitosamente.');
                    document.getElementById('addAdminModal').querySelector('.btn-close').click(); 
                    addForm.reset();
                    cargarTodosLosUsuarios();
                } else {
                    const data = await response.json();
                    alert(`Fallo al registrar: ${data.error}`);
                }
            } catch (error) {
                alert('Error de conexión al registrar administrador.');
            }
        });

        // Listener global para PROMOVER o DEGRADAR (PUT)
        tbody.addEventListener('click', async (e) => {
            const target = e.target;
            const id_usuario = target.getAttribute('data-id');
            if (!id_usuario) return;

            let url = '';
            let action = '';
            let method = 'PUT';

            if (target.classList.contains('promote-user')) {
                action = 'Promover';
                url = `${API_URL}/api/admin/usuarios/promote/${id_usuario}`;
            } else if (target.classList.contains('demote-user')) {
                action = 'Degradar';
                url = `${API_URL}/api/admin/usuarios/demote/${id_usuario}`;
            } else {
                return;
            }
            
            if (!confirm(`¿Estás seguro de ${action} al usuario #${id_usuario}?`)) return;

            try {
                const response = await fetch(url, {
                    method: method,
                    credentials: 'include'
                });

                if (response.ok) {
                    alert(`Usuario #${id_usuario} ha sido ${action === 'Promover' ? 'ascendido' : 'degradado'} correctamente. (Recuerda que el usuario degradado debe cerrar y volver a iniciar sesión para que el cambio surta efecto).`);
                    cargarTodosLosUsuarios();
                } else {
                    const data = await response.json();
                    alert(`Fallo al ${action}: ${data.error}`);
                }
            } catch (error) {
                alert('Error de conexión.');
            }
        });

        document.addEventListener('DOMContentLoaded', cargarTodosLosUsuarios);
    </script>
</body>
</html>