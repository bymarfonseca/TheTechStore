<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin: Gestión de Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Gestión de Pedidos</h1>
        <a href="index.html" class="btn btn-secondary mb-3">Volver al Dashboard</a>
        
        <div id="loading" class="text-info">Cargando pedidos...</div>
        <div id="ordersTableContainer">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Email</th>
                        <th>Total</th>
                        <th>Dirección</th>
                        <th>Estado Pedido</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="pedidosTableBody">
                    </tbody>
            </table>
        </div>
        <div id="errorMsg" class="alert alert-danger d-none"></div>
    </div>

    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailsModalLabel">Detalles del Pedido #<span id="detalle-id-pedido"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Productos:</h6>
                    <ul class="list-group" id="detalle-productos">
                        </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000';
        const tbody = document.getElementById('pedidosTableBody');
        const loading = document.getElementById('loading');
        const errorMsg = document.getElementById('errorMsg');

        // Función auxiliar para obtener detalles de un solo pedido
        async function fetchDetalles(id_pedido) {
            try {
                const response = await fetch(`${API_URL}/api/admin/pedidos/${id_pedido}`, { credentials: 'include' });
                if (!response.ok) throw new Error('Fallo al cargar detalles');
                return await response.json();
            } catch (e) {
                console.error("Error al obtener detalles:", e);
                return [];
            }
        }

        async function cargarPedidos() {
            loading.style.display = 'block';
            errorMsg.classList.add('d-none');
            
            try {
                const response = await fetch(`${API_URL}/api/admin/pedidos`, { credentials: 'include' });
                
                if (response.status === 403) {
                    alert('Acceso denegado. No eres administrador.');
                    window.location.href = 'index.html';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const pedidos = await response.json();
                tbody.innerHTML = ''; 

                if (pedidos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">No hay pedidos registrados.</td></tr>';
                    return;
                }

                pedidos.forEach(pedido => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${pedido.id_pedido}</td>
                        <td>${pedido.nombre_cliente}</td>
                        <td>${pedido.email}</td>
                        <td>$${parseFloat(pedido.total).toFixed(2)}</td>
                        <td>${pedido.direccion}, ${pedido.ciudad}</td>
                        <td>
                            <select class="form-select form-select-sm pedido-estado" data-id="${pedido.id_pedido}">
                                <option value="Pendiente" ${pedido.estado_pedido === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="Procesando" ${pedido.estado_pedido === 'Procesando' ? 'selected' : ''}>Procesando</option>
                                <option value="Enviado" ${pedido.estado_pedido === 'Enviado' ? 'selected' : ''}>Enviado</option>
                                <option value="Entregado" ${pedido.estado_pedido === 'Entregado' ? 'selected' : ''}>Entregado</option>
                            </select>
                        </td>
                        <td><button class="btn btn-info btn-sm ver-detalles" data-id="${pedido.id_pedido}" data-bs-toggle="modal" data-bs-target="#orderDetailsModal">Detalles</button></td>
                    `;
                });

            } catch (error) {
                console.error('Error al cargar pedidos:', error);
                errorMsg.textContent = `Error: No se pudieron cargar los pedidos. ${error.message}`;
                errorMsg.classList.remove('d-none');
            } finally {
                loading.style.display = 'none';
            }
        }

        // Listener para actualizar el estado (PUT)
        tbody.addEventListener('change', async (e) => {
            if (e.target.classList.contains('pedido-estado')) {
                const id_pedido = e.target.getAttribute('data-id');
                const nuevo_estado = e.target.value;

                try {
                    const response = await fetch(`${API_URL}/api/admin/pedidos/${id_pedido}/estado`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nuevo_estado }),
                        credentials: 'include'
                    });

                    if (response.ok) {
                        alert(`Pedido #${id_pedido} actualizado a: ${nuevo_estado}`);
                    } else {
                        throw new Error('Fallo al actualizar el estado en el servidor.');
                    }
                } catch (error) {
                    console.error('Error al actualizar estado:', error);
                    alert('Error al actualizar el estado.');
                    cargarPedidos(); // Recargar para revertir la selección
                }
            }
        });

        // Listener para VER DETALLES (Modal)
        document.getElementById('ordersTableContainer').addEventListener('click', async (e) => {
            if (e.target.classList.contains('ver-detalles')) {
                const id_pedido = e.target.getAttribute('data-id');
                const listaDetalles = document.getElementById('detalle-productos');
                listaDetalles.innerHTML = 'Cargando...';
                document.getElementById('detalle-id-pedido').textContent = id_pedido;

                const detalles = await fetchDetalles(id_pedido);

                listaDetalles.innerHTML = '';
                if (detalles.length === 0) {
                    listaDetalles.innerHTML = '<li class="list-group-item">No se encontraron productos.</li>';
                    return;
                }

                detalles.forEach(d => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = `${d.nombre_producto} (x${d.cantidad}) - $${parseFloat(d.subtotal).toFixed(2)}`;
                    listaDetalles.appendChild(li);
                });
            }
        });

        document.addEventListener('DOMContentLoaded', cargarPedidos);
    </script>
</body>
</html>