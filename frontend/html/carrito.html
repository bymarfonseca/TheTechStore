<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="../../frontend/css/carrito.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
    
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="../../img/logothetechstore.png" alt="logo" width="55" height="70">
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="index.html">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quienessomos.html">驴Qui茅nes somos?</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="catalogo.html">Cat谩logo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contactanos.html">Cont谩ctanos</a>
                    </li>
                    <li class="nav-item d-flex align-items-center" id="userInfoNav">
                        <span class="nav-link">Hola, <strong id="userNameDisplay">Cliente</strong>!</span>
                        <button class="btn btn-danger btn-sm" id="logoutButton">Cerrar Sesi贸n</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="col-md-10">
            <a href="catalogo.html" class="btn btn-primary mt-3 mb-3">Regresar</a>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-4">
                <h5>Pago y Direcci贸n de Env铆o:</h5>
                
                <form id="formdirypago">
                    <div class="mb-3">
                        <label for="direccion" class="form-label">Direcci贸n:</label>
                        <input type="text" class="form-control" id="direccion" name="direccion" required>
                    </div>
                    <div class="mb-3">
                        <p>Estado:</p>
                        <select class="form-select" id="estado" name="estado" required>
                            <option value="">Seleccione...</option>
                            <option value="NuevoLeon">Nuevo Le贸n</option>
                            <option value="CDMX">Ciudad de M茅xico</option>
                            <option value="Guadalajara">Guadalajara</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="ciudad" class="form-label">Ciudad:</label>
                        <input type="text" class="form-control" id="ciudad" name="ciudad" required>
                    </div>
                    <div class="mb-3">
                        <label for="cp" class="form-label">C贸digo Postal:</label>
                        <input type="text" class="form-control" id="cp" name="cp" required>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <label for="numtar" class="form-label">N煤mero de tarjeta:</label>
                        <input type="text" class="form-control" id="numtar" name="numtar" placeholder="**** **** **** ****" required>
                    </div>
                    <div class="mb-3">
                        <label for="nombretarjeta" class="form-label">Nombre en la tarjeta:</label>
                        <input type="text" class="form-control" id="nombretarjeta" name="nombretarjeta" required>
                    </div>
                    <div class="row">
                        <p>Fecha de vencimiento:</p>
                        <div class="col-6 mb-3">
                            <select class="form-select" id="mesvencimiento" name="mesvencimiento" required>
                                <option value="">MM</option>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <select class="form-select" id="anovencimiento" name="anovencimiento" required>
                                <option value="">YYYY</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="cvv" class="form-label">CVV:</label>
                            <input type="text" class="form-control" id="cvv" name="cvv" placeholder="123" required>
                        </div>
                    </div>
                    <div class="btn-container">
                        <button class="btn btn-primary" type="submit">Realizar pedido</button>
                    </div>
                </form>
            </div>
            <div class="col-8">
                <h5 class="text-secondary">Resumen del Carrito</h5>
                <h4>隆Revisa tu pedido!</h4>
                
                <div class="container-fluid" id="items-carrito">
                    <p id="carrito-vacio-msg" class="text-center mt-5 d-none">Tu carrito est谩 vac铆o.</p>
                </div>
                
                <div class="card mt-3 p-3">
                    <p class="h4">Total: <span id="total-carrito">$0.00</span></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
    const API_URL = 'http://localhost:3000';
    const itemsCarritoDiv = document.getElementById('items-carrito');
    const totalCarritoSpan = document.getElementById('total-carrito');
    const formDirYPago = document.getElementById('formdirypago');
    const userNameDisplay = document.getElementById('userNameDisplay');
    const userInfoNav = document.getElementById('userInfoNav');

    // Referencia al elemento de mensaje de carrito vac铆o (para evitar el TypeError)
    const carritoVacioMsg = document.getElementById('carrito-vacio-msg');


    // ==========================================================
    // FUNCIN: CARGAR PRODUCTOS DEL CARRITO (FINALMENTE CORREGIDA)
    // ==========================================================
    async function cargarCarrito() {
        try {
            // AADIDO: { credentials: 'include' } para enviar la cookie de sesi贸n
            const response = await fetch(`${API_URL}/api/carrito`, { credentials: 'include' });
            
            // Si el backend devuelve 401, redirige al login
            if (response.status === 401) {
                alert('Debes iniciar sesi贸n para ver tu carrito.');
                window.location.href = 'login.html';
                return;
            }

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            const carritoItems = data.items || []; 
            
            //  CORRECCIN: Limpiamos SOLO el contenido din谩mico, no el contenedor items-carrito que contiene el mensaje de "vac铆o"
            itemsCarritoDiv.innerHTML = ''; 
            
            if (carritoItems.length === 0) {
                // Si est谩 vac铆o, mostramos el mensaje y el total en 0
                if (carritoVacioMsg) carritoVacioMsg.classList.remove('d-none');
                totalCarritoSpan.textContent = '$0.00';
                //  Re-insertamos el mensaje de vac铆o si no estaba ya dentro
                if (carritoVacioMsg && !itemsCarritoDiv.contains(carritoVacioMsg)) {
                    itemsCarritoDiv.appendChild(carritoVacioMsg);
                }
                return;
            }
            
            // Ocultamos el mensaje de carrito vac铆o si hay 铆tems
            if (carritoVacioMsg) carritoVacioMsg.classList.add('d-none');
            
            // Usamos un fragmento para optimizar la inserci贸n en el DOM
            const fragment = document.createDocumentFragment();

            // 2. Renderizar los productos
            carritoItems.forEach(item => {
                const subtotal = item.subtotal; 
                
                const itemHtml = document.createElement('div');
                itemHtml.className = 'card mb-2 p-3 d-flex flex-row align-items-center';
                itemHtml.innerHTML = `
                    <img src="/TheTechStore/img/${item.imagen || 'default.png'}" alt="${item.nombre}" style="width: 80px; height: auto; margin-right: 15px;">
                    <div class="flex-grow-1">
                        <p class="mb-0"><strong>${item.nombre}</strong></p>
                        <p class="mb-0 text-muted">Precio Unitario: $${item.precio}</p>
                        <p class="mb-0">Cantidad: ${item.cantidad}</p>
                    </div>
                    <div class="text-end">
                        <p class="mb-0">Subtotal: <strong>$${subtotal}</strong></p>
                        <button class="btn btn-danger btn-sm eliminar-item" data-id-producto="${item.id_producto}">Eliminar</button>
                    </div>
                `;
                fragment.appendChild(itemHtml);
            });
            
            itemsCarritoDiv.appendChild(fragment);

            //  Mostrar el total formateado que ya calcul贸 el servidor
            totalCarritoSpan.textContent = `$${data.total}`; 

        } catch (error) {
            console.error('Error cargando el carrito (conexi贸n o formato):', error);
            // Si falla la conexi贸n, mostramos un error claro al usuario
            itemsCarritoDiv.innerHTML = '<p class="text-danger text-center mt-5">Error al cargar los 铆tems del carrito. (Verifique que el servidor Node.js est茅 activo).</p>';
        }
    }
    
    // ==========================================================
    // FUNCIN: MANEJAR ENVO DEL PEDIDO (Checkout)
    // ==========================================================
    formDirYPago.addEventListener('submit', async (e) => {
        e.preventDefault(); 
        
        // 1. Recolectar datos del formulario
        const pedidoData = {
            direccion: document.getElementById('direccion').value,
            estado: document.getElementById('estado').value,
            ciudad: document.getElementById('ciudad').value,
            cp: document.getElementById('cp').value,
            
            datos_pago: {
                numtar: document.getElementById('numtar').value,
                nombretarjeta: document.getElementById('nombretarjeta').value,
                mesvencimiento: document.getElementById('mesvencimiento').value,
                anovencimiento: document.getElementById('anovencimiento').value,
                cvv: document.getElementById('cvv').value,
            }
        };

        try {
            // 2. Enviar datos a la ruta de creaci贸n de pedidos
            const response = await fetch(`${API_URL}/api/pedidos/crear`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pedidoData),
                credentials: 'include' 
            });

            const data = await response.json();

            if (response.ok) {
                alert(`隆Pedido realizado con 茅xito! ID de Pedido: ${data.id_pedido}`);
                // Redirigir a la p谩gina de confirmaci贸n
                window.location.href = 'confirmacion.html?pedido=' + data.id_pedido;
            } else if (response.status === 400) {
                 alert(`Error en el pedido: ${data.error}. Aseg煤rate de que el carrito no est茅 vac铆o.`);
            } else {
                alert(`Error al procesar el pedido: ${data.error || 'Intenta de nuevo. (Revisa la terminal de Node.js).'}`);
            }

        } catch (error) {
            console.error('Error de conexi贸n al crear pedido:', error);
            alert('No se pudo conectar al servidor Node.js para realizar el pedido.');
        }
    });

    // ==========================================================
    // FUNCIN: ELIMINAR ITEM DEL CARRITO
    // ==========================================================
    itemsCarritoDiv.addEventListener('click', async (e) => {
        if (e.target.classList.contains('eliminar-item')) {
            const idProducto = e.target.getAttribute('data-id-producto');
            
            try {
                // Usamos la ruta DELETE en el backend, aunque el m茅todo aqu铆 sea POST/DELETE
                const response = await fetch(`${API_URL}/api/carrito/eliminar/${idProducto}`, {
                    method: 'POST', 
                    credentials: 'include' 
                });

                if (response.ok) {
                    alert('Producto eliminado del carrito.');
                    cargarCarrito(); // Recargar el carrito
                } else {
                    const data = await response.json();
                    alert(`Error al eliminar: ${data.error || 'No se pudo eliminar el producto.'}`);
                }
            } catch (error) {
                console.error('Error de conexi贸n al eliminar:', error);
                alert('Error de conexi贸n con el servidor.');
            }
        }
    });

    // ==========================================================
    // INICIO: Cargar Carrito y Mostrar Info de Usuario
    // ==========================================================
    document.addEventListener('DOMContentLoaded', () => {
        cargarCarrito();
        
        fetch(`${API_URL}/api/session`, { credentials: 'include' })
            .then(res => res.json())
            .then(sessionData => {
                if (sessionData.isLoggedIn) {
                    userNameDisplay.textContent = sessionData.nombre || 'Cliente';
                } else {
                    window.location.href = 'login.html'; 
                }
                
                if (document.getElementById('logoutButton')) {
                    document.getElementById('logoutButton').addEventListener('click', async () => {
                        const logoutResponse = await fetch(`${API_URL}/api/logout`, { method: 'POST', credentials: 'include' });
                        if (logoutResponse.ok) {
                            alert('Sesi贸n cerrada correctamente.');
                            window.location.href = 'index.html'; 
                        } else {
                            alert('Error al cerrar sesi贸n.');
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error al obtener info de sesi贸n:', error);
                window.location.href = 'login.html'; 
            });
    });

    </script>
</body>

</html>