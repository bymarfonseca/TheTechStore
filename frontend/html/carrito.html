<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="../../frontend/css/carrito.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
    
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="../../img/logothetechstore.png" alt="logo" width="55" height="70">
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="index.html">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quienessomos.html">¿Quiénes somos?</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="catalogo.html">Catálogo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contactanos.html">Contáctanos</a>
                    </li>
                    <li class="nav-item d-flex align-items-center" id="userInfoNav">
                        <span class="nav-link">Hola, <strong id="userNameDisplay">Cliente</strong>!</span>
                        <button class="btn btn-danger btn-sm" id="logoutButton">Cerrar Sesión</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="col-md-10">
            <a href="catalogo.html" class="btn btn-primary mt-3 mb-3">Regresar</a>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-4">
                <h5>Pago y Dirección de Envío:</h5>
                
                <form id="formdirypago">
                    <div class="mb-3">
                        <label for="direccion" class="form-label">Dirección:</label>
                        <input type="text" class="form-control" id="direccion" name="direccion" required>
                    </div>
                    <div class="mb-3">
                        <p>Estado:</p>
                        <select class="form-select" id="estado" name="estado" required>
                            <option value="">Seleccione...</option>
                            <option value="NuevoLeon">Nuevo León</option>
                            <option value="CDMX">Ciudad de México</option>
                            <option value="Guadalajara">Guadalajara</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="ciudad" class="form-label">Ciudad:</label>
                        <input type="text" class="form-control" id="ciudad" name="ciudad" required>
                    </div>
                    <div class="mb-3">
                        <label for="cp" class="form-label">Código Postal:</label>
                        <input type="text" class="form-control" id="cp" name="cp" required>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <label for="numtar" class="form-label">Número de tarjeta:</label>
                        <input type="text" class="form-control" id="numtar" name="numtar" placeholder="**** **** **** ****" required>
                    </div>
                    <div class="mb-3">
                        <label for="nombretarjeta" class="form-label">Nombre en la tarjeta:</label>
                        <input type="text" class="form-control" id="nombretarjeta" name="nombretarjeta" required>
                    </div>
                    <div class="row">
                        <p>Fecha de vencimiento:</p>
                        <div class="col-6 mb-3">
                            <select class="form-select" id="mesvencimiento" name="mesvencimiento" required>
                                <option value="">MM</option>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <select class="form-select" id="anovencimiento" name="anovencimiento" required>
                                <option value="">YYYY</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="cvv" class="form-label">CVV:</label>
                            <input type="text" class="form-control" id="cvv" name="cvv" placeholder="123" required>
                        </div>
                    </div>
                    <div class="btn-container">
                        <button class="btn btn-primary" type="submit">Realizar pedido</button>
                    </div>
                </form>
            </div>
            <div class="col-8">
                <h5 class="text-secondary">Resumen del Carrito</h5>
                <h4>¡Revisa tu pedido!</h4>
                
                <div class="container-fluid" id="items-carrito">
                    <p id="carrito-vacio-msg" class="text-center mt-5 d-none">Tu carrito está vacío.</p>
                </div>
                
                <div class="card mt-3 p-3">
                    <p class="h4">Total: <span id="total-carrito">$0.00</span></p>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    const API_URL = 'http://localhost:3000';
    const itemsCarritoDiv = document.getElementById('items-carrito');
    const totalCarritoSpan = document.getElementById('total-carrito');
    const formDirYPago = document.getElementById('formdirypago');
    const userNameDisplay = document.getElementById('userNameDisplay');
    const userInfoNav = document.getElementById('userInfoNav');

    // ==========================================================
    // FUNCIÓN: CARGAR PRODUCTOS DEL CARRITO (CORREGIDA)
    // ==========================================================
    async function cargarCarrito() {
        try {
            // AÑADIDO: { credentials: 'include' }
            const response = await fetch(`${API_URL}/api/carrito`, { credentials: 'include' });
            
            // Si el backend devuelve 401, redirige al login
            if (response.status === 401) {
                alert('Debes iniciar sesión para ver tu carrito.');
                window.location.href = 'login.html';
                return;
            }

            if (!response.ok) {
                throw new Error('Error al obtener el carrito.');
            }
            
            const carrito = await response.json();
            itemsCarritoDiv.innerHTML = '';
            let total = 0;

            if (carrito.length === 0) {
                document.getElementById('carrito-vacio-msg').classList.remove('d-none');
                totalCarritoSpan.textContent = '$0.00';
                return;
            }
            
            document.getElementById('carrito-vacio-msg').classList.add('d-none');

            // 2. Renderizar los productos y calcular el total
            carrito.forEach(item => {
                const subtotal = item.precio * item.cantidad;
                total += subtotal;
                
                const itemHtml = `
                    <div class="card mb-2 p-3 d-flex flex-row align-items-center">
                        <img src="/TheTechStore/img/${item.imagen || 'default.png'}" alt="${item.nombre}" style="width: 80px; height: auto; margin-right: 15px;">
                        <div class="flex-grow-1">
                            <p class="mb-0"><strong>${item.nombre}</strong></p>
                            <p class="mb-0 text-muted">Precio Unitario: $${item.precio}</p>
                            <p class="mb-0">Cantidad: ${item.cantidad}</p>
                        </div>
                        <div class="text-end">
                            <p class="mb-0">Subtotal: <strong>$${subtotal.toFixed(2)}</strong></p>
                            <button class="btn btn-danger btn-sm eliminar-item" data-id-producto="${item.id_producto}">Eliminar</button>
                        </div>
                    </div>
                `;
                itemsCarritoDiv.innerHTML += itemHtml;
            });

            totalCarritoSpan.textContent = `$${total.toFixed(2)}`;

        } catch (error) {
            console.error('Error cargando el carrito:', error);
            itemsCarritoDiv.innerHTML = '<p class="text-danger text-center mt-5">Error al cargar los ítems del carrito.</p>';
        }
    }
    
    // ==========================================================
    // FUNCIÓN: MANEJAR ENVÍO DEL PEDIDO (CORREGIDA)
    // ==========================================================
    formDirYPago.addEventListener('submit', async (e) => {
        e.preventDefault(); 
        
        // 1. Recolectar datos del formulario
        const pedidoData = {
            direccion: document.getElementById('direccion').value,
            estado: document.getElementById('estado').value,
            ciudad: document.getElementById('ciudad').value,
            cp: document.getElementById('cp').value,
            
            datos_pago: {
                numtar: document.getElementById('numtar').value,
                nombretarjeta: document.getElementById('nombretarjeta').value,
                mesvencimiento: document.getElementById('mesvencimiento').value,
                anovencimiento: document.getElementById('anovencimiento').value,
                cvv: document.getElementById('cvv').value,
            }
        };

        try {
            // 2. Enviar datos a la ruta de creación de pedidos (POST /api/pedidos/crear)
            // AÑADIDO: { credentials: 'include' }
            const response = await fetch(`${API_URL}/api/pedidos/crear`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pedidoData),
                credentials: 'include' 
            });

            const data = await response.json();

            if (response.ok) {
                alert(`¡Pedido realizado con éxito! ID de Pedido: ${data.id_pedido}`);
                // 3. Redirigir al catálogo o a una página de confirmación
                window.location.href = 'confirmacion.html?pedido=' + data.id_pedido;
            } else if (response.status === 400) {
                 alert(`Error en el pedido: ${data.error}. Asegúrate de que el carrito no esté vacío.`);
            } else {
                alert(`Error al procesar el pedido: ${data.error || 'Intenta de nuevo.'}`);
            }

        } catch (error) {
            console.error('Error de conexión al crear pedido:', error);
            alert('No se pudo conectar al servidor Node.js para realizar el pedido.');
        }
    });

    // ==========================================================
    // FUNCIÓN: ELIMINAR ITEM DEL CARRITO (CORREGIDA)
    // ==========================================================
    itemsCarritoDiv.addEventListener('click', async (e) => {
        if (e.target.classList.contains('eliminar-item')) {
            const idProducto = e.target.getAttribute('data-id-producto');
            
            try {
                // AÑADIDO: { credentials: 'include' }
                const response = await fetch(`${API_URL}/api/carrito/eliminar/${idProducto}`, {
                    method: 'DELETE',
                    credentials: 'include' 
                });

                if (response.ok) {
                    alert('Producto eliminado del carrito.');
                    cargarCarrito(); // Recargar el carrito
                } else {
                    const data = await response.json();
                    alert(`Error al eliminar: ${data.error || 'No se pudo eliminar el producto.'}`);
                }
            } catch (error) {
                console.error('Error de conexión al eliminar:', error);
                alert('Error de conexión con el servidor.');
            }
        }
    });

    // ==========================================================
    // INICIO: Cargar Carrito y Mostrar Info de Usuario (CORREGIDA)
    // ==========================================================
    document.addEventListener('DOMContentLoaded', () => {
        cargarCarrito();
        
        // AÑADIDO: { credentials: 'include' }
        fetch(`${API_URL}/api/session`, { credentials: 'include' })
            .then(res => res.json())
            .then(sessionData => {
                if (sessionData.isLoggedIn) {
                    userNameDisplay.textContent = sessionData.nombre || 'Cliente';
                } else {
                    window.location.href = 'login.html'; 
                }
                
                if (document.getElementById('logoutButton')) {
                    document.getElementById('logoutButton').addEventListener('click', async () => {
                        // AÑADIDO: { credentials: 'include' }
                        const logoutResponse = await fetch(`${API_URL}/api/logout`, { method: 'POST', credentials: 'include' });
                        if (logoutResponse.ok) {
                            alert('Sesión cerrada correctamente.');
                            window.location.href = 'index.html'; 
                        } else {
                            alert('Error al cerrar sesión.');
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error al obtener info de sesión:', error);
                window.location.href = 'login.html'; 
            });
    });

    </script>
</body>

</html>